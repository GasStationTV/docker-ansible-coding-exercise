# Sample docker app with HAproxy front end

## Overview/Usage

This example uses GCE and CentOS images. While terraform is out of scope, it is leveraged to provision/destroy nodes quickly and provides a dynamic inventory for ansible use.

Once you've created your [GCE api key](https://support.google.com/cloud/answer/6158862#service-accounts), you can drop it in the root directory and name it account.json, it will be consumed by terraform automatically. The gce.tf file is what terraform uses to define your nodes, then the inventory plugin is used for the terraform output. The gce.tf included will result in 3 nodes created.

[Simple diagram of nodes](https://drive.google.com/file/d/0B_pF2IpGCY5va3kycDhuZnVTdUk/view?usp=sharing)

#### Example workflow

```
terraform get
terraform plan
terraform apply
```

This will provision three nodes in your GCE project. From there, all we need to do is run the site.yml playbook. This will run through the roles, the recap should look like below.

```
ansible-playbook site.yml
...
...
PLAY RECAP *********************************************************************
gtv-docker-01              : ok=13   changed=9    unreachable=0    failed=0
gtv-docker-02              : ok=13   changed=9    unreachable=0    failed=0
gtv-haproxy-01             : ok=9    changed=6    unreachable=0    failed=0
```

From here, you should have a functioning stack, two docker nodes each running two docker containers that are added to the HAproxy node. You can run the below command, and curl/browse to your HAproxy node directly and get a cheesy response.

```
➜  docker-ansible-coding-exercise git:(master) ✗ plugins/inventory/terraform.py --hostfile
## begin hosts generated by terraform.py ##
104.196.2.150   	gtv-docker-01
104.196.44.70   	gtv-docker-02
104.196.36.96   	gtv-haproxy-01
## end hosts generated by terraform.py ##
```

#### Cheat Scaling
If you edit the first line of the gce.tf file, and then run through the below commands, you'll get 2 more docker containers added on a 3rd docker node. Additionally if you were to increase the value of the docker_count variable to 4, you would have a total of 8 docker containers without having to adjust any of the roles.

gce.tf line to edit, change 2 to 3
```
variable "docker_count" { default = 2 }
```

Then you'll just run the commands below.
```
terraform apply
```

```
ansible-playbook site.yml
```


#### Future considerations

- Ports are currently hard coded.
- To scale on a container level, both docker_apps and haproxy roles will need to be manually changed, but it's the easiest option without adding new components (consul, etcd, etc.)
- Roles could be leveraged to support both RHEL/Debian systems.
